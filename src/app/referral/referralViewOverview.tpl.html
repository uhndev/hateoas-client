<div id="referral-container" ng-controller="ReferralController as ref" ng-cloak>
  <div layout-gt-md="row" layout-sm="column">
    <div flex-gt-md="30" flex>
      <div layout="column">
        <h2 id="Title">
          Referral Info
        </h2>
        <md-divider></md-divider>
        <md-content flex layout-padding>
          <simple-table
            rows="ref.referralInfo.rows"
            table-data="ref.referralInfo.tableData">
          </simple-table>
        </md-content>
      </div>
    </div>

    <div flex>
      <md-content flex layout-padding>
        <md-tabs id="referral-tabs" md-dynamic-height md-border-bottom>
          <md-tab label="Available Recommendations" ng-disabled="!ref.selectedProgram">
            <md-content class="md-padding">
              <p ng-show="!ref.selectedProgram">
                Please select a program to begin recommending services.
              </p>

              <!-- Service Category / Program Services Panel -->
              <div id="servicesDiv" layout="row" layout-wrap ng-show="ref.selectedProgram">
                <div class="referral-category" flex="50" flex-sm="100" ng-repeat="category in ref.currentCategories">
                  <div class="panel panel-info">
                    <div class="panel-heading">{{category.name}}</div>
                    <div class="panel-body">
                      <div class="row">
                        <div class="col-md-8">
                          <div class="checkbox" ng-repeat="service in ref.availableServices"
                               ng-if="category.id === service.serviceCategory">
                            <label>
                              <input type="checkbox" ng-checked="ref.isServiceRecommended(service)"
                                     ng-click="ref.toggleService(service)"/> {{service.name}}
                            </label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </md-content>
          </md-tab>
          <md-tab label="Recommended Services"
                  ng-disabled="!ref.selectedProgram || ref.recommendedServices.length === 0">
            <!-- Recommended Services Tab -->
            <div layout="row" layout-margin>

              <!-- List of Recommended Services -->
              <md-virtual-repeat-container id="services-list-container" flex class="list-group">
                <div md-virtual-repeat="service in ref.recommendedServices"
                     ng-keydown="ref.navigateKey($event, $index)" focus-if="$index === ref.currIndex"
                     ng-click="ref.selectServiceDetail($index)"
                     class="list-group-item service-item selectable"
                     ng-class="{ 'service-active': $index === ref.currIndex }">
                  <span>
                    {{service.name}}
                    <span ng-if="service.availableSites.length > 0 && service.site">
                      ({{service.siteDictionary[service.site].name}})
                    </span>
                    <span class="text-danger" ng-if="service.availableSites.length > 0 && !service.site">
                      * (select site)
                    </span>
                  </span>
                  <span class="badge selectable" type="button"
                        ng-hide="service == ref.recommendedServices[ref.currIndex]"
                        ng-click="ref.toggleService(service, $event)">
                    <i class="glyphicon glyphicon-remove"></i>
                  </span>
                </div>
              </md-virtual-repeat-container>

              <!-- Service Detail Panels -->
              <div flex="50">
                <!-- Selected Serivce Sites Panel -->
                <div class="panel panel-info service-detail-panel"
                     uib-collapse="!ref.recommendedServices[ref.currIndex] || ref.recommendedServices.length === 0">
                  <div class="panel-heading">
                    <h3 class="panel-title">Selected: {{ref.recommendedServices[ref.currIndex].name}}</h3>
                  </div>
                  <div class="panel-body">
                    <form>
                      <div class="form-group" ng-if="ref.recommendedServices[ref.currIndex].availableSites.length > 0">
                        <label>Select Site:</label>
                        <select ng-model="ref.recommendedServices[ref.currIndex].site" class="form-control"
                                ng-options="site.id as site.name for site in ref.recommendedServices[ref.currIndex].availableSites">
                        </select>
                      </div>
                      <div class="form-group">
                        <div class="checkbox">
                          <label>
                            <input type="checkbox" ng-model="ref.recommendedServices[ref.currIndex].approvalNeeded"/>
                            Approval Needed
                          </label>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Shared Service Detail Selectors -->
                <div class="panel panel-info service-detail-panel">
                  <div class="panel-heading">
                    <h3 class="panel-title">Service Recommendations Info:</h3>
                  </div>
                  <div class="panel-body">
                    <form layout="column">
                      <div class="form-group" flex>
                        <label>Select Physician:</label>
                        <select-loader
                          url="physician"
                          is-atomic="true"
                          is-disabled="false"
                          ng-model="ref.physician"
                          ng-change="ref.setServiceSelections('physician')"
                          labels="displayName">
                        </select-loader>
                      </div>

                      <div class="form-group" flex>
                        <label>Select Clinician:</label>
                        <select-loader
                          url="clinician"
                          is-atomic="true"
                          is-disabled="false"
                          ng-model="ref.clinician"
                          ng-change="ref.setServiceSelections('clinician')"
                          labels="displayName">
                        </select-loader>
                      </div>

                      <div class="form-group" flex>
                        <label>Status:</label>
                        <select-loader
                          url="status"
                          query="{ category: 'referral' }"
                          is-atomic="true"
                          is-disabled="false"
                          ng-model="ref.status"
                          ng-change="ref.setServiceSelections('status')"
                          labels="displayName">
                        </select-loader>
                      </div>

                      <div class="form-group" flex>
                        <label>Work Status:</label>
                        <select-loader
                          url="workstatus"
                          is-atomic="true"
                          is-disabled="false"
                          ng-model="ref.workStatus"
                          ng-change="ref.setServiceSelections('workStatus')"
                          labels="displayName">
                        </select-loader>
                      </div>

                      <div class="form-group" flex>
                        <label>Prognosis:</label>
                        <div flex>
                          <select ng-model="ref.prognosis" ng-change="ref.setServiceSelections('prognosis')"
                                  class="form-control"
                                  ng-options="prognosis as prognosis.name for prognosis in ref.availablePrognosis">
                          </select>
                        </div>
                      </div>

                      <div class="form-group" flex ng-if="ref.prognosis.hasTimeframe">
                        <label>Prognosis Timeframe:</label>
                        <select ng-model="ref.timeframe" ng-change="ref.setServiceSelections('timeframe')"
                                class="form-control"
                                ng-options="timeframe as timeframe.name for timeframe in ref.availableTimeframes">
                        </select>
                      </div>

                      <div class="form-group" flex>
                        <label>Service Type:</label>
                        <br/>
                        <label ng-repeat="(category, serviceTypes) in ::ref.availableServiceTypes">
                          <input type="radio" ng-model="ref.serviceTypeCategory" value="{{::category}}"/> {{::category}}&nbsp;
                        </label>
                        <label>
                          <input type="radio" ng-model="ref.serviceTypeCategory"
                                 ng-click="ref.serviceType = null; ref.setServiceSelections('serviceType')"/> N/A&nbsp;
                        </label>
                        <select ng-model="ref.serviceType" ng-change="ref.setServiceSelections('serviceType')"
                                ng-if="ref.serviceTypeCategory " class="form-control"
                                ng-options="serviceType.id as serviceType.name for serviceType in ref.availableServiceTypes[ref.serviceTypeCategory]">
                        </select>
                      </div>

                      <div class="form-group" flex>
                        <label>Service Date:</label>
                        <p class="input-group">
                          <input type="text"
                                 ng-model="ref.serviceDate"
                                 value="{{ ref.serviceDate | date:'fullDate' }}"
                                 ng-change="ref.setServiceSelections('serviceDate')"
                                 class="form-control"
                                 uib-datepicker-popup
                                 is-open="ref.opened"
                                 required disabled/>
                        <span class="input-group-btn">
                          <button type="button" class="btn btn-default" ng-click="ref.opened = true"><i
                            class="glyphicon glyphicon-calendar"></i></button>
                        </span>
                        </p>
                      </div>
                      <br/>
                      <button class="btn btn-primary pull-right"
                              ng-disabled="ref.recommendedServices.length === 0 || !ref.areServicesValid()"
                              ng-click="ref.saveServices()">
                        Make Recommendations for {{ref.recommendedServices.length}} Service(s)
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </md-tab>
        </md-tabs>
      </md-content>
    </div>
  </div>

  <!--<div id="slideout" ng-class="{'button-out': style_notebarCollapsed}">-->
  <!--<a href="" ng-click="toggleNotebar()">Notes</a>-->
  <!--</div>-->

  <!--<div id="page-notebar" sticky-scroll="40" rightbar-right-position="style_layoutBoxed" style="">-->
  <!--<div jscrollpane="{autoReinitialise:true, autoReinitialiseDelay: 100}" style="height: 100%;padding-bottom:40px">-->

  <!--<altum-notebook notes="ref.notes" note-types="ref.noteTypes" url="ref.noteUrl"></altum-notebook>-->
  <!--</div>-->
  <!--</div>-->

</div>

