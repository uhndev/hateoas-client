<div class="container-fluid" ng-controller="RecommendationsController as rec" ng-cloak>
  <div layout="column">
    <h2 id="Title" flex>
      <span translate>APP.REFERRAL.RECOMMENDATIONS.REFERRAL_RECOMMENDATIONS</span>
    </h2>
    <div id="Query" flex class="clearfix">
      <form>
        <div class="form-group no-margin has-feedback has-feedback-left">
          <i class="no-top form-control-feedback fa fa-search"></i>
          <input type="text" class="form-control"
                 placeholder="{{ 'APP.REFERRAL.RECOMMENDATIONS.LABELS.SEARCH_AVAILABLE_RECOMMENDATIONS' | translate }}"
                 ng-model="rec.search"/>
        </div>
      </form>
      <br/>
    </div>
    <div class="table-responsive" flex>
      <table class="table table-condensed summary-table">
        <tr class="summary-header-row">
          <th ng-repeat="(label, value) in rec.referralOverview" translate>{{label}}</th>
        </tr>
        <tr class="summary-table-row">
          <td ng-repeat="(label, value) in rec.referralOverview">{{value}}</td>
        </tr>
      </table>
    </div>
  </div>

  <altum-notebook ng-if="rec.referralNotes" notes="rec.referralNotes" collection="{'referral': rec.referral.id}"></altum-notebook>

  <div layout="row" layout-md="column">

    <div flex="25" flex-md="100" flex-order="{{rec.serviceOrder.serviceDetail}}" id="shared-detail-panel" layout="column">
      <!-- Selected Service Detail Panel -->
      <div class="panel panel-primary" uib-collapse="!rec.recommendedServices[rec.currIndex]">
        <div class="panel-heading">
          <h3 class="panel-title" ng-if="rec.recommendedServices[rec.currIndex]">
            <i class="fa fa-file-o"></i>
            <b>Selected Service:</b> {{rec.recommendedServices[rec.currIndex].name}}
          <span class="glyphicon glyphicon-transfer selectable pull-right"
                ng-click="rec.swapPanelOrder()"></span>
          </h3>
        </div>
        <div class="panel-body">
          <div class="form-group" ng-if="rec.recommendedServices[rec.currIndex].availableSites.length > 0">
            <label>
              <span translate>APP.REFERRAL.RECOMMENDATIONS.LABELS.SELECT_SITE</span>:&nbsp;
              <span class="fa fa-map-marker fa-lg selectable" ng-click="rec.openMap()"></span>
            </label>
            <select ng-model="rec.recommendedServices[rec.currIndex].site" class="form-control"
                    ng-options="site.id as site.name for site in rec.recommendedServices[rec.currIndex].availableSites">
            </select>
          </div>
          <!-- Save for Scheduling -->
          <!--<div class="form-group" flex ng-repeat="staffType in rec.recommendedServices[rec.currIndex].availableStaffTypes">-->
          <!--<label translate>Select {{staffType.name}}:</label>-->
          <!--<select-loader-->
          <!--url="staff"-->
          <!--query="staffType.baseQuery"-->
          <!--is-atomic="false"-->
          <!--is-disabled="false"-->
          <!--ng-model="rec.recommendedServices[rec.currIndex].staffCollection[staffType.name]"-->
          <!--ng-change="rec.setStaffSelections(rec.recommendedServices[rec.currIndex], staffType.name)"-->
          <!--labels="displayName">-->
          <!--</select-loader>-->
          <!--</div>-->
          <div class="form-group">
            <div class="checkbox">
              <label>
                <input type="checkbox" ng-model="rec.recommendedServices[rec.currIndex].approvalNeeded"
                       ng-checked="rec.recommendedServices[rec.currIndex].approvalNeeded || rec.recommendedServices[rec.currIndex].approvalRequired"
                       ng-disabled="rec.recommendedServices[rec.currIndex].approvalRequired"/>
                Approval {{rec.recommendedServices[rec.currIndex].approvalRequired ? "Required" : "Needed" }}
              </label>
            </div>
          </div>
        </div>
      </div>
      <!-- End Selected Service Detail Panel -->

      <!-- Shared Service Detail Selectors -->
      <div class="panel panel-info">
        <div class="panel-heading">
          <h3 class="panel-title">
            <i class="fa fa-folder-open-o"></i>
            <b translate>APP.REFERRAL.RECOMMENDATIONS.CURRENT_VISIT_INFO</b>
            <span> for {{rec.recommendedServices.length}} service(s)</span>
          <span class="glyphicon glyphicon-transfer selectable pull-right"
                ng-click="rec.swapPanelOrder()"></span>
          </h3>
        </div>
        <div class="panel-body">
          <ng-form layout="column" name="visitForm">
            <div class="form-group" flex>
              <label translate>COMMON.MODELS.SERVICE.PHYSICIAN</label>
              <select-loader
                url="physician"
                is-atomic="true"
                is-disabled="false"
                ng-model="rec.physician"
                ng-change="rec.setServiceSelections('physician')"
                labels="displayName">
              </select-loader>
            </div>

            <div class="form-group" flex ng-repeat="staffType in rec.availableStaffTypes">
              <label translate>{{staffType.name}}</label>
              <select-loader
                url="staff"
                query="staffType.baseQuery"
                is-atomic="false"
                is-disabled="false"
                ng-model="rec.staffCollection[staffType.name]"
                ng-change="rec.setStaffSelections(staffType.name)"
                labels="displayName">
              </select-loader>
            </div>

            <div class="form-group" flex>
              <label translate>COMMON.MODELS.SERVICE.WORK_STATUS</label>
              <select-loader
                url="workstatus"
                is-atomic="true"
                is-disabled="false"
                ng-model="rec.workStatus"
                ng-change="rec.setServiceSelections('workStatus')"
                labels="displayName">
              </select-loader>
            </div>

            <div class="form-group" flex>
              <label translate>COMMON.MODELS.SERVICE.PROGNOSIS</label>
              <div flex>
                <select ng-model="rec.prognosis" ng-change="rec.setServiceSelections('prognosis')"
                        class="form-control"
                        ng-options="prognosis as prognosis.name for prognosis in rec.availablePrognosis">
                </select>
              </div>
            </div>

            <div class="form-group" flex ng-if="rec.prognosis.hasTimeframe">
              <label>
                <span translate>COMMON.MODELS.SERVICE.PROGNOSIS</span>
                <span translate>COMMON.MODELS.SERVICE.TIMEFRAME</span>
              </label>
              <select ng-model="rec.prognosisTimeframe" ng-change="rec.setServiceSelections('prognosisTimeframe')"
                      class="form-control"
                      ng-options="timeframe.id as timeframe.name for timeframe in rec.availableTimeframes">
              </select>
            </div>

            <div class="form-group" flex>
              <label translate>COMMON.MODELS.SERVICE.VISIT_SERVICE</label>
              <span class="text-danger pull-right" ng-if="!rec.visitService"> * required</span>
              <ui-select ng-model="rec.visitService" theme="bootstrap" ng-change="rec.setServiceSelections('visitService')">
                <ui-select-match placeholder="Select Service Type">
                  {{$select.selected.altumServiceName}} ({{$select.selected.approvalDate | date:'short'}})
                </ui-select-match>
                <ui-select-choices repeat="service in rec.referral.approvedServices | filter: $select.search">
                  <span ng-bind-html="service.altumServiceName | highlight: $select.search"></span>
                  <span>({{service.approvalDate | date:'short'}})</span>
                </ui-select-choices>
              </ui-select>
            </div>

            <div class="form-group" flex>
              <label translate>COMMON.MODELS.SERVICE.SERVICE_DATE</label>
              <span class="text-danger pull-right" ng-if="!rec.serviceDate"> * required</span>
              <p class="input-group">
                <input type="text"
                       ng-model="rec.serviceDate"
                       value="{{ rec.serviceDate | date:'fullDate' }}"
                       ng-change="rec.setServiceSelections('serviceDate')"
                       class="form-control"
                       uib-datepicker-popup
                       type="datetime-local"
                       is-open="rec.opened"
                       required disabled/>
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-default" ng-click="rec.opened = true"><i
                          class="glyphicon glyphicon-calendar"></i></button>
                      </span>
              </p>
            </div>
            <br/>
            <button class="btn btn-primary pull-right"
                    ng-disabled="rec.recommendedServices.length === 0 || !rec.areServicesValid() || rec.isSaving"
                    ng-click="rec.saveServices()">
              Make Recommendations for {{rec.recommendedServices.length}} Service(s)
            </button>
          </ng-form>
        </div>
      </div>
      <!-- End Shared Service Detail Selectors -->
    </div>

    <md-tabs id="referral-tabs" flex flex-order="{{rec.serviceOrder.recommendedServices}}" md-dynamic-height md-border-bottom>
      <md-tab ng-disabled="!rec.referral.program" ng-click="rec.currIndex = null">
        <md-tab-label>
          <span translate>APP.REFERRAL.RECOMMENDATIONS.TABS.AVAILABLE_RECOMMENDATIONS</span>
          ({{rec.availableServices.length}})
        </md-tab-label>
        <md-tab-body>
          <p ng-show="!rec.referral.program">
            Please select a program to begin recommending services.
          </p>

          <!-- List View -->
          <md-content layout="column" layout-wrap layout-margin layout-padding ng-show="rec.referral.program">
            <uib-accordion close-others="false">
              <uib-accordion-group
                ng-repeat="(groupKey, groupServices) in rec.availableServices | fuzzy: rec.search | groupBy: 'serviceCategory'"
                ng-init="rec.accordionStatus[groupKey] = true" is-open="rec.accordionStatus[groupKey]"
                panel-class="panel-info">
                <uib-accordion-heading>
                  <i class="glyphicon" ng-class="{
                  'glyphicon-chevron-right': !rec.accordionStatus[groupKey],
                  'glyphicon-chevron-down': rec.accordionStatus[groupKey]
                }"></i>
                  {{groupServices[0].serviceCategoryName}}
                  <span class="pull-right badge">{{groupServices.length}}</span>
                </uib-accordion-heading>
                <div layout="row" layout-sm="column">
                  <div flex ng-repeat="block in groupServices | chunkBy: ((groupServices.length / 3) < 1 ? 1 : (groupServices.length / 3))">
                    <div layout="column">
                      <div class="checkbox" ng-repeat="service in block">
                        <label>
                          <input type="checkbox" ng-checked="rec.isServiceRecommended(service)"
                                 ng-click="rec.toggleService(service)"/> {{service.name}}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </uib-accordion-group>
            </uib-accordion>
          </md-content>
        </md-tab-body>
      </md-tab>
      <md-tab ng-click="rec.fetchLoaderData()"
              ng-disabled="!rec.referral.program || rec.recommendedServices.length === 0">
        <md-tab-label>
          <span translate>APP.REFERRAL.RECOMMENDATIONS.TABS.RECOMMENDED_SERVICES</span>
          ({{rec.recommendedServices.length}})
        </md-tab-label>
        <md-tab-body>
          <!-- Recommended Services Tab -->
          <md-content layout="row" layout-margin>

            <!-- List of Recommended Services -->
            <div class="list-group" flex>
              <div ng-repeat="service in rec.recommendedServices"
                   ng-keydown="rec.navigateKey($event, $index)" focus-if="$index === rec.currIndex"
                   ng-click="rec.selectServiceDetail($index)"
                   class="list-group-item service-item selectable"
                   ng-class="{ 'service-active': $index === rec.currIndex }">
                <span>
                  {{service.name}}
                  <span ng-if="service.availableSites.length > 0 && service.site">
                    ({{service.siteDictionary[service.site].name}})
                  </span>
                  <span class="text-danger" ng-if="service.availableSites.length > 0 && !service.site">
                    * (select site)
                  </span>
                </span>
                <span class="badge selectable" type="button"
                      ng-hide="service == rec.recommendedServices[rec.currIndex]"
                      ng-click="rec.toggleService(service, $event)">
                  <i class="fa fa-times"></i>
                </span>
                <span class="badge selectable" type="button"
                      ng-hide="service == rec.recommendedServices[rec.currIndex]"
                      ng-click="rec.duplicateService(service, $index, $event)">
                  <i class="fa fa-files-o"></i>
                </span>
              </div>
            </div>
            <!-- End List of Recommended Services -->

          </md-content>
        </md-tab-body>
      </md-tab>
    </md-tabs>
  </div>
</div>
